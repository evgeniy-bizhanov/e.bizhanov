# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  desc "Description of what the lane does"
  lane :fast_lane do
    # ensure_git_status_clean


    # Чистим директории проекта

    clear_derived_data

    xcclean(
    	scheme: "e.bizhanov",
	workspace: "e.bizhanov.xcworkspace"
    )


    # Обновляем поды

    cocoapods(
	use_bundle_exec: false
    )


    # Запускаем тесты

    run_tests(
	devices: ["iPhone X"],
	scheme: "e.bizhanov"
    )


    # Делаем скриншоты с помощью Fastlane snapshot

    capture_ios_screenshots(
	skip_open_summary: true
    )


    # Номер сборки, версия

    increment_build_number

#    set_info_plist_value(
#	path: "./e.bizhanov/Environments/info.plist",
#	key: "CFBundleShortVersionString",
#	value: "1.3"
#    )

    increment_version_number(
	version_number: "1.3.4" # Set a specific version number
    )


    # Сборка

    gym(
	scheme: "e.bizhanov",
	configuration: "Debug",
	export_method: "development",
	include_symbols: true,
	include_bitcode: true,
	silent: false,
	output_directory: "./bin",
	output_name: "market.ipa"
    )


    # Commit

    versionNumber = get_version_number
    buildNumber = get_build_number

    tag = "#{versionNumber}.#{buildNumber}"

    git_add
    git_commit(
	path: [
	    "*"
	],
	message: "Инкремент версии"
    )

    add_git_tag(
	tag: tag
    )


    # Testflight

#    upload_to_testflight(
#	username: "username",
#	app_identifier: "com.bizhanov.e-bizhanov",
#	itc_provider: "password"
#    )
    

  end


end
